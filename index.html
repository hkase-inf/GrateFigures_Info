<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>æƒ…å ±å­¦ã®å‰äºº ã‚¹ã‚¿ãƒ³ãƒ—ãƒ©ãƒªãƒ¼</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- âœ… QRã‚³ãƒ¼ãƒ‰èª­ã¿å–ã‚Šãƒ©ã‚¤ãƒ–ãƒ©ãƒªï¼ˆå¿…é ˆï¼‰ -->
  <!-- ã“ã‚ŒãŒèª­ã¿è¾¼ã‚ãªã„ã¨ Html5Qrcode is not defined ã«ãªã‚Šã¾ã™ -->
  <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>

  <style>
    :root {
      --bg: #f4f5fb;
      --card: #ffffff;
      --accent: #2563eb;
      --accent-soft: #dbeafe;
      --text-main: #111827;
      --text-sub: #4b5563;
      --ok: #16a34a;
      --border: #e5e7eb;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #e0f2fe, #f9fafb 60%);
      color: var(--text-main);
    }

    .page {
      max-width: 960px;
      margin: 0 auto;
      padding: 1.5rem 1.25rem 3rem;
    }

    h1 {
      font-size: clamp(1.6rem, 2.4vw + 1rem, 2.2rem);
      margin: 0 0 0.25rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    h1 span.emoji {
      font-size: 1.4em;
    }

    .subtitle {
      color: var(--text-sub);
      font-size: 0.95rem;
      margin-bottom: 1rem;
    }

    .panel {
      background: rgba(255, 255, 255, 0.9);
      border-radius: 1.25rem;
      padding: 1.25rem 1.25rem 1.5rem;
      box-shadow: 0 18px 40px rgba(15, 23, 42, 0.12);
      border: 1px solid rgba(148, 163, 184, 0.25);
      backdrop-filter: blur(10px);
    }

    .panel-header {
      display: flex;
      flex-wrap: wrap;
      gap: 0.75rem;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 1rem;
    }

    .hint {
      font-size: 0.8rem;
      color: var(--text-sub);
      display: flex;
      align-items: center;
      gap: 0.35rem;
    }

    .hint-badge {
      font-size: 0.7rem;
      padding: 0.1rem 0.4rem;
      border-radius: 999px;
      background: var(--accent-soft);
      color: var(--accent);
      font-weight: 600;
    }

    .status-bar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 0.75rem;
      margin-bottom: 0.75rem;
      flex-wrap: wrap;
    }

    .progress-text {
      font-size: 0.9rem;
      color: var(--text-sub);
    }

    .progress-strong {
      font-weight: 600;
      color: var(--accent);
    }

    .progress-bar-outer {
      flex: 1;
      height: 0.5rem;
      border-radius: 999px;
      background: #e5e7eb;
      overflow: hidden;
    }

    .progress-bar-inner {
      height: 100%;
      width: 0;
      background: linear-gradient(90deg, #22c55e, #0ea5e9);
      transition: width 0.25s ease;
    }

    .btn-row {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
    }

    button {
      border-radius: 999px;
      border: none;
      padding: 0.6rem 1.2rem;
      font-size: 0.9rem;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 0.4rem;
      font-weight: 600;
      transition: transform 0.08s ease, box-shadow 0.08s ease, background 0.1s ease, color 0.1s ease;
    }

    button:active {
      transform: translateY(1px) scale(0.99);
      box-shadow: none;
    }

    .btn-primary {
      background: var(--accent);
      color: white;
      box-shadow: 0 10px 20px rgba(37, 99, 235, 0.35);
    }

    .btn-primary[disabled] {
      background: #9ca3af;
      box-shadow: none;
      cursor: default;
    }

    .btn-subtle {
      background: rgba(15, 23, 42, 0.03);
      color: var(--text-sub);
    }

    .btn-danger {
      background: transparent;
      color: #b91c1c;
      border: 1px solid #fecaca;
      padding: 0.45rem 0.8rem;
      font-size: 0.8rem;
      border-radius: 999px;
      cursor: pointer;
    }

    .btn-danger:hover {
      background: #fef2f2;
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(170px, 1fr));
      gap: 0.8rem;
      margin-top: 1rem;
    }

    .stamp-card {
      background: var(--card);
      border-radius: 0.9rem;
      padding: 0.7rem 0.8rem;
      border: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      gap: 0.35rem;
      position: relative;
      overflow: hidden;
    }

    .stamp-card.complete {
      border-color: rgba(22, 163, 74, 0.2);
      background: linear-gradient(135deg, #ecfdf3, #f0f9ff);
    }

    .stamp-title {
      font-size: 0.95rem;
      font-weight: 600;
      display: flex;
      align-items: baseline;
      gap: 0.4rem;
    }

    .stamp-title-ja {
      font-size: 0.8rem;
      color: var(--text-sub);
    }

    .stamp-status {
      font-size: 0.8rem;
      display: flex;
      align-items: center;
      gap: 0.3rem;
      color: var(--text-sub);
    }

    .stamp-status span.badge {
      font-size: 0.7rem;
      border-radius: 999px;
      padding: 0.08rem 0.5rem;
      font-weight: 600;
    }

    .badge-done {
      background: #bbf7d0;
      color: #166534;
    }

    .badge-yet {
      background: #e5e7eb;
      color: #4b5563;
    }

    .stamp-stampmark {
      position: absolute;
      right: -6px;
      bottom: -6px;
      font-size: 2.2rem;
      opacity: 0.08;
      transform: rotate(-15deg);
      pointer-events: none;
    }

    .stamp-card.complete .stamp-stampmark {
      opacity: 0.22;
    }

    .message {
      margin-top: 0.75rem;
      font-size: 0.85rem;
      padding: 0.75rem 0.85rem;
      border-radius: 0.75rem;
      border: 1px solid #e5e7eb;
      background: rgba(248, 250, 252, 0.9);
      display: flex;
      gap: 0.45rem;
      align-items: flex-start;
    }

    .message-icon {
      font-size: 1.2rem;
      line-height: 1;
      margin-top: -0.1rem;
    }

    .message strong {
      display: block;
      margin-bottom: 0.15rem;
    }

    .message-success {
      border-color: #bbf7d0;
      background: #f0fdf4;
    }

    .camera-block {
      margin-top: 1rem;
      border-radius: 0.9rem;
      border: 1px dashed #cbd5f5;
      padding: 0.6rem;
      background: rgba(239, 246, 255, 0.6);
    }

    #qr-reader {
      width: 100%;
      max-width: 420px;
      margin-inline: auto;
    }

    footer {
      margin-top: 1.25rem;
      font-size: 0.75rem;
      color: #6b7280;
      text-align: center;
    }

    @media (prefers-color-scheme: dark) {
      body {
        background: radial-gradient(circle at top, #020617, #020617 60%);
        color: #e5e7eb;
      }
      .panel {
        background: rgba(15, 23, 42, 0.96);
        border-color: rgba(51, 65, 85, 0.8);
      }
      .stamp-card {
        background: #020617;
        border-color: #1f2937;
      }
      .stamp-card.complete {
        background: radial-gradient(circle at top left, #064e3b, #020617 65%);
      }
      .message {
        background: rgba(15, 23, 42, 0.9);
        border-color: #1f2937;
      }
      .message-success {
        background: rgba(5, 46, 22, 0.9);
        border-color: #14532d;
      }
      .camera-block {
        background: rgba(15, 23, 42, 0.9);
        border-color: #1f2937;
      }
    }
  </style>
</head>
<body>
  <main class="page">
    <header>
      <h1>
        <span class="emoji">ğŸ“š</span>
        æƒ…å ±å­¦ã®å‰äººã‚¹ã‚¿ãƒ³ãƒ—ãƒ©ãƒªãƒ¼
      </h1>
      <p class="subtitle">
        ã‚­ãƒ£ãƒ³ãƒ‘ã‚¹å†…ã®ãƒã‚¹ã‚¿ãƒ¼ã®QRã‚³ãƒ¼ãƒ‰ã‚’ã‚¹ã‚­ãƒ£ãƒ³ã™ã‚‹ã¨ã€å‰äººã”ã¨ã®ã‚¹ã‚¿ãƒ³ãƒ—ãŒãŸã¾ã‚Šã¾ã™ã€‚
        <br />9äººã™ã¹ã¦é›†ã‚ã‚‹ã¨ã‚³ãƒ³ãƒ—ãƒªãƒ¼ãƒˆã§ã™ï¼
      </p>
    </header>

    <section class="panel" aria-label="ã‚¹ã‚¿ãƒ³ãƒ—é€²è¡ŒçŠ¶æ³">
      <div class="panel-header">
        <div class="status-bar">
          <div class="progress-bar-outer">
            <div id="progress-bar" class="progress-bar-inner"></div>
          </div>
          <div class="progress-text">
            <span class="progress-strong" id="progress-count">0 / 9</span> ã‚¹ã‚¿ãƒ³ãƒ—
          </div>
        </div>

        <div class="btn-row">
          <button id="scan-toggle" class="btn-primary" type="button">
            <span id="scan-toggle-icon">ğŸ“·</span>
            <span id="scan-toggle-text">ã‚«ãƒ¡ãƒ©ã‚’èµ·å‹•</span>
          </button>
          <button id="open-target-page" class="btn-subtle" type="button">
            ğŸ”— å‰äººç´¹ä»‹ãƒšãƒ¼ã‚¸ã‚’é–‹ã
          </button>
        </div>
      </div>

      <div class="hint">
        <span class="hint-badge">ä½¿ã„æ–¹</span>
        <span>1. ã¾ãšã“ã®ãƒšãƒ¼ã‚¸ã‚’é–‹ã â†’ 2. ä¸‹ã®ã€Œã‚«ãƒ¡ãƒ©ã‚’èµ·å‹•ã€ â†’ 3. ãƒã‚¹ã‚¿ãƒ¼ã®QRã‚³ãƒ¼ãƒ‰ã«ã‹ã–ã™</span>
      </div>

      <div id="completion-message" class="message message-success" style="display:none;">
        <div class="message-icon">ğŸ‰</div>
        <div>
          <strong>ã‚³ãƒ³ãƒ—ãƒªãƒ¼ãƒˆãŠã‚ã§ã¨ã†ã”ã–ã„ã¾ã™ï¼</strong>
          9äººã®å‰äººã‚’ã™ã¹ã¦å›ã‚Šã¾ã—ãŸã€‚è¨˜å¿µå†™çœŸã‚’æ’®ã£ãŸã‚Šã€å‹ã ã¡ã«ã‚‚ãœã²æ•™ãˆã¦ã‚ã’ã¦ãã ã•ã„ã€‚
        </div>
      </div>

      <div id="scan-message" class="message" style="display:none;">
        <div class="message-icon" id="scan-message-icon">âœ…</div>
        <div id="scan-message-text"></div>
      </div>

      <div class="camera-block" id="camera-block" style="display:none;">
        <div id="qr-reader"></div>
      </div>

      <div class="grid" aria-label="ã‚¹ã‚¿ãƒ³ãƒ—ä¸€è¦§">
        <!-- JSã§æŒ¿å…¥ -->
      </div>

      <div style="margin-top:0.8rem; display:flex; justify-content:flex-end;">
        <button id="reset-button" class="btn-danger" type="button">
          é€²è¡ŒçŠ¶æ³ã‚’ãƒªã‚»ãƒƒãƒˆ
        </button>
      </div>
    </section>

    <footer>
      ã“ã®ã‚¹ã‚¿ãƒ³ãƒ—ãƒ©ãƒªãƒ¼ã®è¨˜éŒ²ã¯ã€ã“ã®ç«¯æœ«ã®ãƒ–ãƒ©ã‚¦ã‚¶å†…ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ï¼‰ã«ã®ã¿ä¿å­˜ã•ã‚Œã¾ã™ã€‚
    </footer>
  </main>

  <script>
    // --- è¨­å®š: å‰äººã¨QRã‚³ãƒ¼ãƒ‰URLãƒ•ãƒ©ã‚°ãƒ¡ãƒ³ãƒˆã®å¯¾å¿œ --------------------

    const FIGURES = [
      {
        id: "gratefigures_01",
        nameEn: "Grace Hopper",
        nameJa: "ã‚°ãƒ¬ã‚¤ã‚¹ãƒ»ãƒ›ãƒƒãƒ‘ãƒ¼",
        fragment: "#gratefigures_01",
        url: "https://wwp.shizuoka.ac.jp/vision-i/%E6%83%85%E5%A0%B1%E5%AD%A6%E3%81%AE%E5%81%89%E4%BA%BA/#gratefigures_01"
      },
      {
        id: "gratefigures_02",
        nameEn: "Tim Berners-Lee",
        nameJa: "ãƒ†ã‚£ãƒ ãƒ»ãƒãƒ¼ãƒŠãƒ¼ã‚ºï¼ãƒªãƒ¼",
        fragment: "#gratefigures_02",
        url: "https://wwp.shizuoka.ac.jp/vision-i/%E6%83%85%E5%A0%B1%E5%AD%A6%E3%81%AE%E5%81%89%E4%BA%BA/#gratefigures_02"
      },
      {
        id: "greatfigures_03",
        nameEn: "Marvin Minsky",
        nameJa: "ãƒãƒ¼ãƒ´ã‚£ãƒ³ãƒ»ãƒŸãƒ³ã‚¹ã‚­ãƒ¼",
        fragment: "#greatfigures_03",
        url: "https://wwp.shizuoka.ac.jp/vision-i/%E6%83%85%E5%A0%B1%E5%AD%A6%E3%81%AE%E5%81%89%E4%BA%BA/#greatfigures_03"
      },
      {
        id: "greatfigures_04",
        nameEn: "Alan Turing",
        nameJa: "ã‚¢ãƒ©ãƒ³ãƒ»ãƒãƒ¥ãƒ¼ãƒªãƒ³ã‚°",
        fragment: "#greatfigures_04",
        url: "https://wwp.shizuoka.ac.jp/vision-i/%E6%83%85%E5%A0%B1%E5%AD%A6%E3%81%AE%E5%81%89%E4%BA%BA/#greatfigures_04"
      },
      {
        id: "greatfigures_05",
        nameEn: "Claude Shannon",
        nameJa: "ã‚¯ãƒ­ãƒ¼ãƒ‰ãƒ»ã‚·ãƒ£ãƒãƒ³",
        fragment: "#greatfigures_05",
        url: "https://wwp.shizuoka.ac.jp/vision-i/%E6%83%85%E5%A0%B1%E5%AD%A6%E3%81%AE%E5%81%89%E4%BA%BA/#greatfigures_05"
      },
      {
        id: "greatfigures_06",
        nameEn: "John von Neumann",
        nameJa: "ã‚¸ãƒ§ãƒ³ãƒ»ãƒ•ã‚©ãƒ³ãƒ»ãƒã‚¤ãƒãƒ³",
        fragment: "#greatfigures_06",
        url: "https://wwp.shizuoka.ac.jp/vision-i/%E6%83%85%E5%A0%B1%E5%AD%A6%E3%81%AE%E5%81%89%E4%BA%BA/#greatfigures_06"
      },
      {
        id: "greatfigures_07",
        nameEn: "Alan Kay",
        nameJa: "ã‚¢ãƒ©ãƒ³ãƒ»ã‚±ã‚¤",
        fragment: "#greatfigures_07",
        url: "https://wwp.shizuoka.ac.jp/vision-i/%E6%83%85%E5%A0%B1%E5%AD%A6%E3%81%AE%E5%81%89%E4%BA%BA/#greatfigures_07"
      },
      {
        id: "greatfigures_08",
        nameEn: "Jun Murai",
        nameJa: "æ‘äº• ç´”",
        fragment: "#greatfigures_08",
        url: "https://wwp.shizuoka.ac.jp/vision-i/%E6%83%85%E5%A0%B1%E5%AD%A6%E3%81%AE%E5%81%89%E4%BA%BA/#greatfigures_08"
      },
      {
        id: "greatfigures_09",
        nameEn: "Herbert A. Simon",
        nameJa: "ãƒãƒ¼ãƒãƒ¼ãƒˆãƒ»ã‚µã‚¤ãƒ¢ãƒ³",
        fragment: "#greatfigures_09",
        url: "https://wwp.shizuoka.ac.jp/vision-i/%E6%83%85%E5%A0%B1%E5%AD%A6%E3%81%AE%E5%81%89%E4%BA%BA/#greatfigures_09"
      }
    ];

    const STORAGE_KEY = "info-legends-stamp-v1";

    let state = { stamps: {}, lastUpdated: null };

    function loadState() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (raw) state = Object.assign(state, JSON.parse(raw));
      } catch (e) {
        console.error("Failed to load state:", e);
      }
      FIGURES.forEach(f => {
        if (!(f.id in state.stamps)) state.stamps[f.id] = false;
      });
    }

    function saveState() {
      try {
        state.lastUpdated = new Date().toISOString();
        localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
      } catch (e) {
        console.error("Failed to save state:", e);
      }
    }

    const gridEl = document.querySelector(".grid");
    const progressCountEl = document.getElementById("progress-count");
    const progressBarEl = document.getElementById("progress-bar");
    const completionMessageEl = document.getElementById("completion-message");
    const scanMessageEl = document.getElementById("scan-message");
    const scanMessageIconEl = document.getElementById("scan-message-icon");
    const scanMessageTextEl = document.getElementById("scan-message-text");

    function renderGrid() {
      gridEl.innerHTML = "";
      FIGURES.forEach((fig, index) => {
        const done = !!state.stamps[fig.id];
        const card = document.createElement("article");
        card.className = "stamp-card" + (done ? " complete" : "");
        card.setAttribute("data-id", fig.id);
        card.innerHTML = `
          <div class="stamp-title">
            <span>${index + 1}. ${fig.nameEn}</span>
            <span class="stamp-title-ja">${fig.nameJa}</span>
          </div>
          <div class="stamp-status">
            <span class="badge ${done ? "badge-done" : "badge-yet"}">
              ${done ? "GET!" : "ã¾ã "}
            </span>
            <span>${done ? "QRã‚³ãƒ¼ãƒ‰ã‚’èª­ã¿å–ã‚Šæ¸ˆã¿" : "ãƒã‚¹ã‚¿ãƒ¼ã®QRã‚³ãƒ¼ãƒ‰ã‚’ã•ãŒã—ã¦ã‚¹ã‚­ãƒ£ãƒ³ã—ã‚ˆã†"}</span>
          </div>
          <div class="stamp-stampmark">STAMP</div>
        `;
        gridEl.appendChild(card);
      });
    }

    function updateProgress() {
      const total = FIGURES.length;
      const doneCount = FIGURES.filter(f => state.stamps[f.id]).length;
      progressCountEl.textContent = `${doneCount} / ${total}`;
      progressBarEl.style.width = `${(doneCount / total) * 100}%`;
      completionMessageEl.style.display = doneCount === total ? "flex" : "none";
    }

    function showScanMessage(type, html) {
      scanMessageEl.style.display = "flex";
      scanMessageTextEl.innerHTML = html;
      if (type === "success") {
        scanMessageEl.classList.add("message-success");
        scanMessageIconEl.textContent = "âœ…";
      } else if (type === "error") {
        scanMessageEl.classList.remove("message-success");
        scanMessageIconEl.textContent = "âš ï¸";
      } else {
        scanMessageEl.classList.remove("message-success");
        scanMessageIconEl.textContent = "â„¹ï¸";
      }
    }

    let html5QrCode = null;
    let isScanning = false;

    const scanToggleBtn = document.getElementById("scan-toggle");
    const scanToggleText = document.getElementById("scan-toggle-text");
    const scanToggleIcon = document.getElementById("scan-toggle-icon");
    const cameraBlockEl = document.getElementById("camera-block");

    async function ensureCameraPermission() {
      if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
        throw new Error("ã“ã®ç«¯æœ«ï¼ãƒ–ãƒ©ã‚¦ã‚¶ã§ã¯ã‚«ãƒ¡ãƒ©APIãŒåˆ©ç”¨ã§ãã¾ã›ã‚“ã€‚");
      }
      let stream;
      try {
        stream = await navigator.mediaDevices.getUserMedia({
          video: { facingMode: "environment" }
        });
        stream.getTracks().forEach(track => track.stop());
      } catch (err) {
        throw err;
      }
    }

    async function startScanning() {
      if (isScanning) return;

      // âœ… ã“ã“ã§ãƒ©ã‚¤ãƒ–ãƒ©ãƒªèª­ã¿è¾¼ã¿ãƒã‚§ãƒƒã‚¯
      if (typeof Html5Qrcode === "undefined") {
        showScanMessage(
          "error",
          "QRã‚³ãƒ¼ãƒ‰èª­ã¿å–ã‚Šãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’èª­ã¿è¾¼ã‚ã¾ã›ã‚“ã§ã—ãŸã€‚ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚„CDNã¸ã®ã‚¢ã‚¯ã‚»ã‚¹åˆ¶é™ã‚’ã”ç¢ºèªãã ã•ã„ã€‚"
        );
        return;
      }

      cameraBlockEl.style.display = "block";
      scanToggleBtn.disabled = true;
      scanToggleText.textContent = "èµ·å‹•ä¸­â€¦";
      scanToggleIcon.textContent = "â³";

      try {
        await ensureCameraPermission();

        if (!html5QrCode) {
          html5QrCode = new Html5Qrcode("qr-reader");
        }

        const config = { fps: 10, qrbox: 260 };

        await html5QrCode.start(
          { facingMode: "environment" },
          config,
          onQrCodeScanned,
          () => {}
        );

        isScanning = true;
        scanToggleBtn.disabled = false;
        scanToggleText.textContent = "ã‚«ãƒ¡ãƒ©ã‚’åœæ­¢";
        scanToggleIcon.textContent = "ğŸ›‘";
        showScanMessage("info", "ãƒã‚¹ã‚¿ãƒ¼ã®QRã‚³ãƒ¼ãƒ‰ã«ã‹ã–ã—ã¦ãã ã•ã„ã€‚");
      } catch (err) {
        console.error("Failed to start scanner:", err);

        let msg = "ã‚«ãƒ¡ãƒ©ã‚’èµ·å‹•ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚ãƒ–ãƒ©ã‚¦ã‚¶ã®è¨­å®šã‚„HTTPSæ¥ç¶šï¼ˆGitHub Pagesï¼‰ã‚’ã”ç¢ºèªãã ã•ã„ã€‚";
        if (err.name === "NotAllowedError" || err.name === "SecurityError") {
          msg = "ãƒ–ãƒ©ã‚¦ã‚¶ã‹ã‚‰ã‚«ãƒ¡ãƒ©ä½¿ç”¨ãŒæ‹’å¦ã•ã‚Œã¾ã—ãŸã€‚ã‚¢ãƒ‰ãƒ¬ã‚¹ãƒãƒ¼ä»˜è¿‘ã®ã‚«ãƒ¡ãƒ©ã‚¢ã‚¤ã‚³ãƒ³ã‹ã‚‰ã€Œè¨±å¯ã€ã«å¤‰æ›´ã—ã¦ãã ã•ã„ã€‚";
        } else if (err.name === "NotFoundError" || err.name === "OverconstrainedError") {
          msg = "ã‚«ãƒ¡ãƒ©ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚ã“ã®ç«¯æœ«ã«ã‚«ãƒ¡ãƒ©ãŒæ­è¼‰ã•ã‚Œã¦ã„ã‚‹ã‹ã”ç¢ºèªãã ã•ã„ã€‚";
        } else if (err.message && err.message.includes("ã‚«ãƒ¡ãƒ©APIãŒåˆ©ç”¨ã§ãã¾ã›ã‚“")) {
          msg = err.message;
        }

        showScanMessage("error", msg);

        isScanning = false;
        cameraBlockEl.style.display = "none";
        scanToggleBtn.disabled = false;
        scanToggleText.textContent = "ã‚«ãƒ¡ãƒ©ã‚’èµ·å‹•";
        scanToggleIcon.textContent = "ğŸ“·";
      }
    }

    async function stopScanning() {
      if (!isScanning) return;

      scanToggleBtn.disabled = true;
      scanToggleText.textContent = "åœæ­¢ä¸­â€¦";
      scanToggleIcon.textContent = "â³";

      try {
        if (html5QrCode && html5QrCode.isScanning) {
          await html5QrCode.stop();
        }
      } catch (err) {
        console.error("Failed to stop scanner:", err);
      }

      isScanning = false;
      cameraBlockEl.style.display = "none";
      scanToggleBtn.disabled = false;
      scanToggleText.textContent = "ã‚«ãƒ¡ãƒ©ã‚’èµ·å‹•";
      scanToggleIcon.textContent = "ğŸ“·";
    }

    function onQrCodeScanned(decodedText) {
      const trimmed = decodedText.trim();
      const figure = FIGURES.find(f => trimmed.includes(f.fragment));

      if (!figure) {
        showScanMessage(
          "info",
          `ã“ã®QRã‚³ãƒ¼ãƒ‰ã¯ã€ã“ã®ã‚¹ã‚¿ãƒ³ãƒ—ãƒ©ãƒªãƒ¼ã®å¯¾è±¡å¤–ã®ã‚ˆã†ã§ã™ã€‚<br><small>èª­ã¿å–ã£ãŸå†…å®¹: <code>${escapeHtml(trimmed.slice(0, 80))}${trimmed.length > 80 ? "â€¦" : ""}</code></small>`
        );
        return;
      }

      if (state.stamps[figure.id]) {
        showScanMessage(
          "info",
          `${figure.nameEn}ï¼ˆ${figure.nameJa}ï¼‰ã®ã‚¹ã‚¿ãƒ³ãƒ—ã¯ã™ã§ã«å–å¾—æ¸ˆã¿ã§ã™ã€‚`
        );
      } else {
        state.stamps[figure.id] = true;
        saveState();
        renderGrid();
        updateProgress();
        showScanMessage(
          "success",
          `${figure.nameEn}ï¼ˆ${figure.nameJa}ï¼‰ã®ã‚¹ã‚¿ãƒ³ãƒ—ã‚’ã‚²ãƒƒãƒˆã—ã¾ã—ãŸï¼`
        );
      }
    }

    function escapeHtml(str) {
      return str.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
    }

    scanToggleBtn.addEventListener("click", () => {
      if (!isScanning) startScanning();
      else stopScanning();
    });

    document.getElementById("reset-button").addEventListener("click", () => {
      if (!window.confirm("æœ¬å½“ã«ã‚¹ã‚¿ãƒ³ãƒ—ã®é€²è¡ŒçŠ¶æ³ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ")) return;
      FIGURES.forEach(f => (state.stamps[f.id] = false));
      saveState();
      renderGrid();
      updateProgress();
      showScanMessage("info", "ã‚¹ã‚¿ãƒ³ãƒ—ã®é€²è¡ŒçŠ¶æ³ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸã€‚");
    });

    document.getElementById("open-target-page").addEventListener("click", () => {
      window.open(
        "https://wwp.shizuoka.ac.jp/vision-i/%E6%83%85%E5%A0%B1%E5%AD%A6%E3%81%AE%E5%81%89%E4%BA%BA/",
        "_blank",
        "noopener"
      );
    });

    loadState();
    renderGrid();
    updateProgress();

    window.addEventListener("pagehide", () => stopScanning());
    window.addEventListener("beforeunload", () => stopScanning());
  </script>
</body>
</html>
