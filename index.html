import React, { useState, useEffect, useRef } from 'react';
import { Camera, Award, CheckCircle, Circle, QrCode, X } from 'lucide-react';

const pioneers = [
  { id: 1, name: 'ã‚°ãƒ¬ã‚¤ã‚¹ãƒ»ãƒ›ãƒƒãƒ‘ãƒ¼', nameEn: 'Grace Hopper', field: 'ã‚³ãƒ³ãƒ‘ã‚¤ãƒ©ã®é–‹ç™º' },
  { id: 2, name: 'ãƒ†ã‚£ãƒ ãƒ»ãƒãƒ¼ãƒŠãƒ¼ã‚º=ãƒªãƒ¼', nameEn: 'Tim Berners-Lee', field: 'World Wide Web' },
  { id: 3, name: 'ãƒãƒ¼ãƒ´ã‚£ãƒ³ãƒ»ãƒŸãƒ³ã‚¹ã‚­ãƒ¼', nameEn: 'Marvin Minsky', field: 'äººå·¥çŸ¥èƒ½' },
  { id: 4, name: 'ã‚¢ãƒ©ãƒ³ãƒ»ãƒãƒ¥ãƒ¼ãƒªãƒ³ã‚°', nameEn: 'Alan Turing', field: 'è¨ˆç®—ç†è«–' },
  { id: 5, name: 'ã‚¯ãƒ­ãƒ¼ãƒ‰ãƒ»ã‚·ãƒ£ãƒãƒ³', nameEn: 'Claude Shannon', field: 'æƒ…å ±ç†è«–' },
  { id: 6, name: 'ã‚¸ãƒ§ãƒ³ãƒ»ãƒ•ã‚©ãƒ³ãƒ»ãƒã‚¤ãƒãƒ³', nameEn: 'John von Neumann', field: 'ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ã‚¿è¨­è¨ˆ' },
  { id: 7, name: 'ã‚¢ãƒ©ãƒ³ãƒ»ã‚±ã‚¤', nameEn: 'Alan Kay', field: 'ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆæŒ‡å‘' },
  { id: 8, name: 'æ‘äº• ç´”', nameEn: 'Jun Murai', field: 'æ—¥æœ¬ã®ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆ' },
  { id: 9, name: 'ãƒãƒ¼ãƒãƒ¼ãƒˆãƒ»ã‚µã‚¤ãƒ¢ãƒ³', nameEn: 'Herbert Simon', field: 'äººå·¥çŸ¥èƒ½ãƒ»èªçŸ¥ç§‘å­¦' }
];

export default function StampRally() {
  const [collectedStamps, setCollectedStamps] = useState([]);
  const [scanning, setScanning] = useState(false);
  const [showComplete, setShowComplete] = useState(false);
  const [lastScanned, setLastScanned] = useState(null);
  const videoRef = useRef(null);
  const canvasRef = useRef(null);
  const streamRef = useRef(null);
  const scanIntervalRef = useRef(null);

  useEffect(() => {
    const saved = localStorage.getItem('stampRallyProgress');
    if (saved) {
      const stamps = JSON.parse(saved);
      setCollectedStamps(stamps);
      if (stamps.length === pioneers.length) {
        setShowComplete(true);
      }
    }
  }, []);

  useEffect(() => {
    localStorage.setItem('stampRallyProgress', JSON.stringify(collectedStamps));
    if (collectedStamps.length === pioneers.length && collectedStamps.length > 0) {
      setShowComplete(true);
    }
  }, [collectedStamps]);

  const startScanning = async () => {
    try {
      const stream = await navigator.mediaDevices.getUserMedia({ 
        video: { facingMode: 'environment' } 
      });
      
      if (videoRef.current) {
        videoRef.current.srcObject = stream;
        streamRef.current = stream;
        setScanning(true);
        
        videoRef.current.onloadedmetadata = () => {
          videoRef.current.play();
          scanIntervalRef.current = setInterval(scanQRCode, 500);
        };
      }
    } catch (err) {
      alert('ã‚«ãƒ¡ãƒ©ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ãŒè¨±å¯ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ãƒ–ãƒ©ã‚¦ã‚¶ã®è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
    }
  };

  const stopScanning = () => {
    if (streamRef.current) {
      streamRef.current.getTracks().forEach(track => track.stop());
      streamRef.current = null;
    }
    if (scanIntervalRef.current) {
      clearInterval(scanIntervalRef.current);
      scanIntervalRef.current = null;
    }
    setScanning(false);
  };

  const scanQRCode = () => {
    if (!videoRef.current || !canvasRef.current) return;

    const video = videoRef.current;
    const canvas = canvasRef.current;
    const context = canvas.getContext('2d');

    if (video.readyState === video.HAVE_ENOUGH_DATA) {
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      context.drawImage(video, 0, 0, canvas.width, canvas.height);

      const imageData = context.getImageData(0, 0, canvas.width, canvas.height);
      const code = jsQR(imageData.data, imageData.width, imageData.height);

      if (code) {
        handleQRCodeScanned(code.data);
      }
    }
  };

  const handleQRCodeScanned = (data) => {
    // é™å²¡å¤§å­¦ã®URLã‹ã‚‰å‰äººIDã‚’æŠ½å‡º
    const match = data.match(/grate?figures_(\d+)/);
    if (match) {
      const pioneerId = parseInt(match[1]);
      const pioneer = pioneers.find(p => p.id === pioneerId);
      
      if (pioneer && !collectedStamps.includes(pioneerId)) {
        setCollectedStamps([...collectedStamps, pioneerId]);
        setLastScanned(pioneer);
        stopScanning();
        
        setTimeout(() => setLastScanned(null), 3000);
      }
    }
  };

  const resetProgress = () => {
    if (confirm('ã‚¹ã‚¿ãƒ³ãƒ—ãƒ©ãƒªãƒ¼ã®é€²æ—ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹?')) {
      setCollectedStamps([]);
      setShowComplete(false);
      localStorage.removeItem('stampRallyProgress');
    }
  };

  const progress = (collectedStamps.length / pioneers.length) * 100;

  return (
    <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 p-4">
      <div className="max-w-2xl mx-auto">
        <div className="bg-white rounded-2xl shadow-xl p-6 mb-6">
          <div className="text-center mb-6">
            <h1 className="text-3xl font-bold text-indigo-900 mb-2">
              æƒ…å ±å­¦ã®å‰äººã‚¹ã‚¿ãƒ³ãƒ—ãƒ©ãƒªãƒ¼
            </h1>
            <p className="text-gray-600">
              9äººã®å‰äººã‚’è¦‹ã¤ã‘ã¦ã‚¹ã‚¿ãƒ³ãƒ—ã‚’é›†ã‚ã‚ˆã†!
            </p>
          </div>

          <div className="mb-6">
            <div className="flex justify-between items-center mb-2">
              <span className="text-sm font-medium text-gray-700">
                {collectedStamps.length} / {pioneers.length} é”æˆ
              </span>
              <span className="text-sm font-medium text-indigo-600">
                {Math.round(progress)}%
              </span>
            </div>
            <div className="w-full bg-gray-200 rounded-full h-3">
              <div 
                className="bg-gradient-to-r from-indigo-500 to-purple-500 h-3 rounded-full transition-all duration-500"
                style={{ width: `${progress}%` }}
              />
            </div>
          </div>

          {!scanning ? (
            <button
              onClick={startScanning}
              className="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-4 px-6 rounded-xl transition-colors flex items-center justify-center gap-2 shadow-lg"
            >
              <Camera size={24} />
              QRã‚³ãƒ¼ãƒ‰ã‚’ã‚¹ã‚­ãƒ£ãƒ³
            </button>
          ) : (
            <div className="space-y-4">
              <div className="relative bg-black rounded-xl overflow-hidden">
                <video 
                  ref={videoRef} 
                  className="w-full"
                  playsInline
                  muted
                />
                <div className="absolute inset-0 border-4 border-indigo-500 pointer-events-none">
                  <div className="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-48 h-48 border-2 border-white rounded-lg" />
                </div>
              </div>
              <button
                onClick={stopScanning}
                className="w-full bg-red-500 hover:bg-red-600 text-white font-bold py-3 px-6 rounded-xl transition-colors flex items-center justify-center gap-2"
              >
                <X size={20} />
                ã‚­ãƒ£ãƒ³ã‚»ãƒ«
              </button>
            </div>
          )}
          
          <canvas ref={canvasRef} className="hidden" />
        </div>

        {lastScanned && (
          <div className="bg-green-500 text-white rounded-2xl shadow-xl p-6 mb-6 animate-bounce">
            <div className="text-center">
              <CheckCircle size={48} className="mx-auto mb-3" />
              <h3 className="text-2xl font-bold mb-2">ã‚¹ã‚¿ãƒ³ãƒ—ç²å¾—!</h3>
              <p className="text-lg">{lastScanned.name}</p>
              <p className="text-sm opacity-90">{lastScanned.field}</p>
            </div>
          </div>
        )}

        {showComplete && (
          <div className="bg-gradient-to-r from-yellow-400 to-orange-400 text-white rounded-2xl shadow-xl p-8 mb-6">
            <div className="text-center">
              <Award size={64} className="mx-auto mb-4" />
              <h2 className="text-3xl font-bold mb-2">ğŸ‰ ã‚³ãƒ³ãƒ—ãƒªãƒ¼ãƒˆ! ğŸ‰</h2>
              <p className="text-lg">
                ãŠã‚ã§ã¨ã†ã”ã–ã„ã¾ã™!<br />
                ã™ã¹ã¦ã®å‰äººã‚’ç™ºè¦‹ã—ã¾ã—ãŸ!
              </p>
            </div>
          </div>
        )}

        <div className="bg-white rounded-2xl shadow-xl p-6">
          <h2 className="text-xl font-bold text-gray-800 mb-4 flex items-center gap-2">
            <QrCode size={24} />
            ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³
          </h2>
          <div className="grid grid-cols-1 gap-3">
            {pioneers.map(pioneer => {
              const collected = collectedStamps.includes(pioneer.id);
              return (
                <div
                  key={pioneer.id}
                  className={`p-4 rounded-xl border-2 transition-all ${
                    collected
                      ? 'bg-indigo-50 border-indigo-300'
                      : 'bg-gray-50 border-gray-200 opacity-60'
                  }`}
                >
                  <div className="flex items-center gap-3">
                    {collected ? (
                      <CheckCircle className="text-indigo-600 flex-shrink-0" size={24} />
                    ) : (
                      <Circle className="text-gray-400 flex-shrink-0" size={24} />
                    )}
                    <div className="flex-1 min-w-0">
                      <h3 className="font-bold text-gray-900 truncate">
                        {pioneer.name}
                      </h3>
                      <p className="text-sm text-gray-600 truncate">
                        {pioneer.nameEn}
                      </p>
                      <p className="text-xs text-gray-500 mt-1">
                        {pioneer.field}
                      </p>
                    </div>
                  </div>
                </div>
              );
            })}
          </div>

          <button
            onClick={resetProgress}
            className="w-full mt-6 bg-gray-200 hover:bg-gray-300 text-gray-700 font-medium py-3 px-6 rounded-xl transition-colors"
          >
            é€²æ—ã‚’ãƒªã‚»ãƒƒãƒˆ
          </button>
        </div>
      </div>

      <script src="https://cdnjs.cloudflare.com/ajax/libs/jsqr/1.4.0/jsQR.min.js"></script>
    </div>
  );
}