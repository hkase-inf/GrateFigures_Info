<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ÊÉÖÂ†±Â≠¶„ÅÆÂÅâ‰∫∫„Çπ„Çø„É≥„Éó„É©„É™„Éº</title>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jsqr/1.4.0/jsQR.min.js"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
</head>
<body>
  <div id="root"></div>
  
  <script type="text/babel">
    const { useState, useEffect, useRef } = React;
    const { Camera, Award, CheckCircle, Circle, QrCode, X } = lucide;

    const pioneers = [
      { id: 1, name: '„Ç∞„É¨„Ç§„Çπ„Éª„Éõ„ÉÉ„Éë„Éº', nameEn: 'Grace Hopper', field: '„Ç≥„É≥„Éë„Ç§„É©„ÅÆÈñãÁô∫' },
      { id: 2, name: '„ÉÜ„Ç£„É†„Éª„Éê„Éº„Éä„Éº„Ç∫=„É™„Éº', nameEn: 'Tim Berners-Lee', field: 'World Wide Web' },
      { id: 3, name: '„Éû„Éº„É¥„Ç£„É≥„Éª„Éü„É≥„Çπ„Ç≠„Éº', nameEn: 'Marvin Minsky', field: '‰∫∫Â∑•Áü•ËÉΩ' },
      { id: 4, name: '„Ç¢„É©„É≥„Éª„ÉÅ„É•„Éº„É™„É≥„Ç∞', nameEn: 'Alan Turing', field: 'Ë®àÁÆóÁêÜË´ñ' },
      { id: 5, name: '„ÇØ„É≠„Éº„Éâ„Éª„Ç∑„É£„Éé„É≥', nameEn: 'Claude Shannon', field: 'ÊÉÖÂ†±ÁêÜË´ñ' },
      { id: 6, name: '„Ç∏„Éß„É≥„Éª„Éï„Ç©„É≥„Éª„Éé„Ç§„Éû„É≥', nameEn: 'John von Neumann', field: '„Ç≥„É≥„Éî„É•„Éº„ÇøË®≠Ë®à' },
      { id: 7, name: '„Ç¢„É©„É≥„Éª„Ç±„Ç§', nameEn: 'Alan Kay', field: '„Ç™„Éñ„Ç∏„Çß„ÇØ„ÉàÊåáÂêë' },
      { id: 8, name: 'Êùë‰∫ï Á¥î', nameEn: 'Jun Murai', field: 'Êó•Êú¨„ÅÆ„Ç§„É≥„Çø„Éº„Éç„ÉÉ„Éà' },
      { id: 9, name: '„Éè„Éº„Éê„Éº„Éà„Éª„Çµ„Ç§„É¢„É≥', nameEn: 'Herbert Simon', field: '‰∫∫Â∑•Áü•ËÉΩ„ÉªË™çÁü•ÁßëÂ≠¶' }
    ];

    function StampRally() {
      const [collectedStamps, setCollectedStamps] = useState([]);
      const [scanning, setScanning] = useState(false);
      const [showComplete, setShowComplete] = useState(false);
      const [lastScanned, setLastScanned] = useState(null);
      const videoRef = useRef(null);
      const canvasRef = useRef(null);
      const streamRef = useRef(null);
      const scanIntervalRef = useRef(null);

      useEffect(() => {
        const saved = localStorage.getItem('stampRallyProgress');
        if (saved) {
          const stamps = JSON.parse(saved);
          setCollectedStamps(stamps);
          if (stamps.length === pioneers.length) {
            setShowComplete(true);
          }
        }
      }, []);

      useEffect(() => {
        localStorage.setItem('stampRallyProgress', JSON.stringify(collectedStamps));
        if (collectedStamps.length === pioneers.length && collectedStamps.length > 0) {
          setShowComplete(true);
        }
      }, [collectedStamps]);

      const startScanning = async () => {
        try {
          const stream = await navigator.mediaDevices.getUserMedia({ 
            video: { facingMode: 'environment' } 
          });
          
          if (videoRef.current) {
            videoRef.current.srcObject = stream;
            streamRef.current = stream;
            setScanning(true);
            
            videoRef.current.onloadedmetadata = () => {
              videoRef.current.play();
              scanIntervalRef.current = setInterval(scanQRCode, 500);
            };
          }
        } catch (err) {
          alert('„Ç´„É°„É©„Å∏„ÅÆ„Ç¢„ÇØ„Çª„Çπ„ÅåË®±ÂèØ„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇ„Éñ„É©„Ç¶„Ç∂„ÅÆË®≠ÂÆö„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
        }
      };

      const stopScanning = () => {
        if (streamRef.current) {
          streamRef.current.getTracks().forEach(track => track.stop());
          streamRef.current = null;
        }
        if (scanIntervalRef.current) {
          clearInterval(scanIntervalRef.current);
          scanIntervalRef.current = null;
        }
        setScanning(false);
      };

      const scanQRCode = () => {
        if (!videoRef.current || !canvasRef.current) return;

        const video = videoRef.current;
        const canvas = canvasRef.current;
        const context = canvas.getContext('2d');

        if (video.readyState === video.HAVE_ENOUGH_DATA) {
          canvas.width = video.videoWidth;
          canvas.height = video.videoHeight;
          context.drawImage(video, 0, 0, canvas.width, canvas.height);

          const imageData = context.getImageData(0, 0, canvas.width, canvas.height);
          const code = jsQR(imageData.data, imageData.width, imageData.height);

          if (code) {
            handleQRCodeScanned(code.data);
          }
        }
      };

      const handleQRCodeScanned = (data) => {
        const match = data.match(/grate?figures_(\d+)/);
        if (match) {
          const pioneerId = parseInt(match[1]);
          const pioneer = pioneers.find(p => p.id === pioneerId);
          
          if (pioneer && !collectedStamps.includes(pioneerId)) {
            setCollectedStamps([...collectedStamps, pioneerId]);
            setLastScanned(pioneer);
            stopScanning();
            
            setTimeout(() => setLastScanned(null), 3000);
          }
        }
      };

      const resetProgress = () => {
        if (confirm('„Çπ„Çø„É≥„Éó„É©„É™„Éº„ÅÆÈÄ≤Êçó„Çí„É™„Çª„ÉÉ„Éà„Åó„Åæ„Åô„Åã?')) {
          setCollectedStamps([]);
          setShowComplete(false);
          localStorage.removeItem('stampRallyProgress');
        }
      };

      const progress = (collectedStamps.length / pioneers.length) * 100;

      return (
        <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 p-4">
          <div className="max-w-2xl mx-auto">
            <div className="bg-white rounded-2xl shadow-xl p-6 mb-6">
              <div className="text-center mb-6">
                <h1 className="text-3xl font-bold text-indigo-900 mb-2">
                  ÊÉÖÂ†±Â≠¶„ÅÆÂÅâ‰∫∫„Çπ„Çø„É≥„Éó„É©„É™„Éº
                </h1>
                <p className="text-gray-600">
                  9‰∫∫„ÅÆÂÅâ‰∫∫„ÇíË¶ã„Å§„Åë„Å¶„Çπ„Çø„É≥„Éó„ÇíÈõÜ„ÇÅ„Çà„ÅÜ!
                </p>
              </div>

              <div className="mb-6">
                <div className="flex justify-between items-center mb-2">
                  <span className="text-sm font-medium text-gray-700">
                    {collectedStamps.length} / {pioneers.length} ÈÅîÊàê
                  </span>
                  <span className="text-sm font-medium text-indigo-600">
                    {Math.round(progress)}%
                  </span>
                </div>
                <div className="w-full bg-gray-200 rounded-full h-3">
                  <div 
                    className="bg-gradient-to-r from-indigo-500 to-purple-500 h-3 rounded-full transition-all duration-500"
                    style={{ width: `${progress}%` }}
                  />
                </div>
              </div>

              {!scanning ? (
                <button
                  onClick={startScanning}
                  className="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-4 px-6 rounded-xl transition-colors flex items-center justify-center gap-2 shadow-lg"
                >
                  <Camera size={24} />
                  QR„Ç≥„Éº„Éâ„Çí„Çπ„Ç≠„É£„É≥
                </button>
              ) : (
                <div className="space-y-4">
                  <div className="relative bg-black rounded-xl overflow-hidden">
                    <video 
                      ref={videoRef} 
                      className="w-full"
                      playsInline
                      muted
                    />
                    <div className="absolute inset-0 border-4 border-indigo-500 pointer-events-none">
                      <div className="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-48 h-48 border-2 border-white rounded-lg" />
                    </div>
                  </div>
                  <button
                    onClick={stopScanning}
                    className="w-full bg-red-500 hover:bg-red-600 text-white font-bold py-3 px-6 rounded-xl transition-colors flex items-center justify-center gap-2"
                  >
                    <X size={20} />
                    „Ç≠„É£„É≥„Çª„É´
                  </button>
                </div>
              )}
              
              <canvas ref={canvasRef} className="hidden" />
            </div>

            {lastScanned && (
              <div className="bg-green-500 text-white rounded-2xl shadow-xl p-6 mb-6 animate-bounce">
                <div className="text-center">
                  <CheckCircle size={48} className="mx-auto mb-3" />
                  <h3 className="text-2xl font-bold mb-2">„Çπ„Çø„É≥„ÉóÁç≤Âæó!</h3>
                  <p className="text-lg">{lastScanned.name}</p>
                  <p className="text-sm opacity-90">{lastScanned.field}</p>
                </div>
              </div>
            )}

            {showComplete && (
              <div className="bg-gradient-to-r from-yellow-400 to-orange-400 text-white rounded-2xl shadow-xl p-8 mb-6">
                <div className="text-center">
                  <Award size={64} className="mx-auto mb-4" />
                  <h2 className="text-3xl font-bold mb-2">üéâ „Ç≥„É≥„Éó„É™„Éº„Éà! üéâ</h2>
                  <p className="text-lg">
                    „Åä„ÇÅ„Åß„Å®„ÅÜ„Åî„Åñ„ÅÑ„Åæ„Åô!<br />
                    „Åô„Åπ„Å¶„ÅÆÂÅâ‰∫∫„ÇíÁô∫Ë¶ã„Åó„Åæ„Åó„Åü!
                  </p>
                </div>
              </div>
            )}

            <div className="bg-white rounded-2xl shadow-xl p-6">
              <h2 className="text-xl font-bold text-gray-800 mb-4 flex items-center gap-2">
                <QrCode size={24} />
                „Ç≥„É¨„ÇØ„Ç∑„Éß„É≥
              </h2>
              <div className="grid grid-cols-1 gap-3">
                {pioneers.map(pioneer => {
                  const collected = collectedStamps.includes(pioneer.id);
                  return (
                    <div
                      key={pioneer.id}
                      className={`p-4 rounded-xl border-2 transition-all ${
                        collected
                          ? 'bg-indigo-50 border-indigo-300'
                          : 'bg-gray-50 border-gray-200 opacity-60'
                      }`}
                    >
                      <div className="flex items-center gap-3">
                        {collected ? (
                          <CheckCircle className="text-indigo-600 flex-shrink-0" size={24} />
                        ) : (
                          <Circle className="text-gray-400 flex-shrink-0" size={24} />
                        )}
                        <div className="flex-1 min-w-0">
                          <h3 className="font-bold text-gray-900 truncate">
                            {pioneer.name}
                          </h3>
                          <p className="text-sm text-gray-600 truncate">
                            {pioneer.nameEn}
                          </p>
                          <p className="text-xs text-gray-500 mt-1">
                            {pioneer.field}
                          </p>
                        </div>
                      </div>
                    </div>
                  );
                })}
              </div>

              <button
                onClick={resetProgress}
                className="w-full mt-6 bg-gray-200 hover:bg-gray-300 text-gray-700 font-medium py-3 px-6 rounded-xl transition-colors"
              >
                ÈÄ≤Êçó„Çí„É™„Çª„ÉÉ„Éà
              </button>
            </div>
          </div>
        </div>
      );
    }

    ReactDOM.render(<StampRally />, document.getElementById('root'));
  </script>
</body>
</html>